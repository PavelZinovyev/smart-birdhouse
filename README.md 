# ESP32 — умная кормушка (контроллер)

Фирмвар для ESP32: датчики (расстояние, температура/влажность), управление питанием Raspberry Pi и сигналы старта/остановки записи.

## Оборудование

- **VL53L0X** — дальность до объекта (определение птицы в кормушке)
- **SHT31** — температура и влажность
- **GPIO** — сигналы к Pi, управление питанием, LED

## Пины (ESP32)

| Пин | Назначение |
|-----|------------|
| 21  | I2C SDA    |
| 20  | I2C SCL    |
| 6   | `PI_SIGNAL_PIN` — выход: HIGH = команда Pi начать запись |
| 4   | `PI_READY_PIN` — вход: HIGH = Pi готов/пишет, LOW = можно выключать |
| 5   | `PI_POWER_PIN` — выход на MOSFET: LOW = питание Pi включено |
| 7   | LED        |

## Логика (state machine)

1. **IDLE** — опрос расстояния; при расстоянии < 50 мм несколько раз подряд → «птица», включение питания Pi.
2. **POWERING_PI** — ожидание `PI_READY_PIN == HIGH`, затем на `PI_SIGNAL_PIN` даётся HIGH (старт записи).
3. **RECORDING** — ожидание `PI_READY_PIN == LOW` (Pi закончил запись).
4. **COOLDOWN** — пауза ~5 с, затем переход в IDLE.

## Файлы

- `lib/main.py` — основной скетч (Arduino/C++; по факту C++, имя файла может быть `.ino`/`.cpp` в зависимости от сборки).

## Сборка и загрузка

Используется среда Arduino или PlatformIO. Подключить библиотеки: **Adafruit SHT31**, **Adafruit VL53L0X**, **Wire**. Загрузить скетч на ESP32 через USB.


# Raspberry Pi — запись видео

Скрипты на Python для записи видео по сигналу с ESP32: GPIO-триггер и бенчмарки rpicam-vid.

## Пины (BCM)

| Пин | Назначение |
|-----|------------|
| 17  | `PI_SIGNAL_PIN` — вход: HIGH = начать запись, LOW = остановить |
| 27  | `PI_READY_PIN` — выход: HIGH = идёт запись / Pi занят |

Схема согласована с ESP32: Pi читает сигнал старта с 17, отдаёт «готовность» на 27.

## Файлы в `lib/`

| Файл | Описание |
|------|----------|
| **bird_recorder.py** | Основной скрипт: цикл по GPIO, при HIGH на 17 — запись в MP4 через `rpicam-vid` (libav), при LOW или по таймауту — остановка. Видео сохраняются в `VIDEO_DIR`. |
| **video_bench.py** | Бенчмарк: прямая запись в MP4 и запись H264 + конвертация в MP4; замеры CPU, RAM, температуры. |
| **test_gpio.py** | Тест чтения пинов 17 и 27 в цикле (проверка проводки/сигналов). |
| **test_recorder.py** | Общие настройки для тестов записи (каталог, длительность, разрешение, framerate, bitrate). |

## Зависимости

- Python 3
- **RPi.GPIO**
- **rpicam-vid** (системный пакет на Raspberry Pi OS)
- Для бенчмарка: **psutil**

## Запуск

Основная запись по триггеру (обычно с автозапуском или systemd):

```bash
python3 lib/bird_recorder.py
```

Бенчмарк (создаёт тестовые ролики и выводит метрики):

```bash
python3 lib/video_bench.py
```

Проверка GPIO:

```bash
python3 lib/test_gpio.py
```

## Настройки

В `bird_recorder.py`: `VIDEO_DIR`, `MAX_RECORD_TIME`, `WIDTH`, `HEIGHT`, `FRAMERATE`, `PROCESS_TIMEOUT`. В `video_bench.py` и `test_recorder.py` — свои константы под тесты.
